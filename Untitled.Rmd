---
title: "R Notebook"
output: html_notebook
---

```{r echo=FALSE, results = FALSE, message=FALSE, warning=FALSE, cache=TRUE, fig.show='hide'}
##################################################################################################################
##  EXPERIMENT 6 DATA PROCESSING:                                                                               ##
##################################################################################################################
##  Import demographics, RFG justifications, and RFBG justifications:
    exp6__p_info_files <- c(
        "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_questionnaire-z6yh.csv", # Demog (v6)
        "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_questionnaire-h32i.csv")  # RFG just (v6)

##  Create raw df from the above files, but only get the following columns:
    exp6__participant_info <- map_dfr(exp6__p_info_files,~read_csv(.x, col_types = cols_only(
        "Participant Private ID"='c', "Participant Public ID"='c', "UTC Date"='c', "Participant OS"='c',
        "Participant Browser"='c', "Participant Monitor Size"='c', "branch-ebg9"='c', "randomiser-6j1g"='c', 
        "randomiser-rj7w"='c', "randomiser-enay"='c', "randomiser-gw7n"='c', "randomiser-uc11"='c', 
        "randomiser-hpp5"='c', "randomiser-qhxy"='c', "randomiser-vvav"='c', "Question Key"='c', 
        "Response"='c'))) %>%
    ##  Merge columns that contain the same type of data, but were originally split into different columns:
        unite(study_list, "randomiser-6j1g", "randomiser-rj7w", "randomiser-enay", "randomiser-gw7n",
              "randomiser-uc11", "randomiser-hpp5", "randomiser-qhxy", "randomiser-vvav", remove = TRUE, 
              na.rm = TRUE) %>%
    ##  Rename some columns:    
        rename(id = "Participant Private ID", prolific_id = "Participant Public ID", date = "UTC Date",
               system = "Participant OS", browser = "Participant Browser", monitor = "Participant Monitor Size",
               test_list = "branch-ebg9", question = "Question Key", response = "Response") %>%
    ##  Reorder columns:    
        select(id, prolific_id, date, system, browser, monitor, study_list, test_list, question, response) %>%
    ##  Set participant ID as the grouping variable, and arrange data by participant ID:
        group_by(id) %>%
        arrange(id) %>%
    ##  Remove empty / unimportant rows:
        drop_na(id) %>%
        filter(question != "BEGIN QUESTIONNAIRE") %>%    
        filter(question != "END QUESTIONNAIRE") %>%
    ##  Reformat from long to wide:
        spread(key = question, value = response) %>%
    ##  Remove unimportant columns:    
        select(-"age-quantised", -"attention_check-quantised", -"EngFirstLang-quantised", -"ethnicity-quantised", 
               -"ethnicity2-quantised", -"ethnicity3-quantised", -"mem_skills_1-quantised", 
               -"mem_skills_2-quantised", -"response-6-quantised", -"response-9-quantised") %>%
    ##  Merge multiple rows into one (per participant):
        summarise_all(coalesce_by_column) %>%
    ##  Rename more columns:
        rename(white = "ethnicity", mixed = "ethnicity2", asian = "ethnicity3", eng_first_lang = "EngFirstLang",
               mixed_other = "response-4", asian_other = "response-15", black = "response-6", 
               black_other = "response-7", other_ethnic = "response-9", other_ethnic_specified = "response-4") %>%
    ##  Reorder columns again:   
        select(id, prolific_id, date, system, browser, monitor, study_list, test_list, age, gender, 
                 eng_first_lang, white, white_other, mixed, mixed_other, asian, asian_other, black, 
                 black_other, other_ethnic, other_ethnic_specified, rec_justification, fam_justification,
                 guess_justification, mem_skills_1, mem_skills_2, attention_check) %>%
    ##  Recode attention check to show pass or fail:
        mutate(attention_check = str_replace(attention_check, "a lot better", "pass")) %>%
        mutate(attention_check = str_replace_all(attention_check, c("a lot worse" = "fail",
                                                                    "a little worse" = "fail", "the same" = "fail",
                                                                    "a little better" = "fail"))) %>%
    ##  Tidy up responses for clarity:
        mutate_all(., tolower) %>%
        mutate(system = str_remove_all(system, "\\ .+")) %>%
        mutate(browser = str_remove_all(browser, "\\ .+")) %>%
        mutate(mixed = str_remove_all(mixed, "\\ .+")) %>%
        mutate(asian = str_remove_all(asian, "\\ .+")) %>%
        mutate(black = str_remove_all(black, "\\ .+")) %>%
        mutate(gender = str_replace(gender, "^m$", "male")) %>%
        mutate(gender = replace_na(gender, "unspecified")) %>%
        arrange(study_list, test_list)


##    Calculate how many items P got correct during study:
##    Import study data:
      exp6__study_files <- c(
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-l7li.csv", # Study Red1 (pics=only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-qi5x.csv", # Study Red1 (pics-only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-pifd.csv", # Study Red2 (pics+word)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-uf3l.csv", # Study Red2 (pics+word)          
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-a3o7.csv", # Study Orange1 (pics-only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-1u76.csv", # Study Orange2 (pics-only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-3n1f.csv", # Study Orange1 (pics+word)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-5ium.csv", # Study Orange2 (pics+word)
                    
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-a9z8.csv",  # Study Yellow (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-bqu6.csv",  # Study Yellow (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-1v1k.csv",  # Study Yellow (pics+word)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-ggr4.csv",  # Study Yellow (pics+word)
          
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-okc7.csv",  # Study Green (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-wmoz.csv",  # Study Green (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-jlur.csv",  # Study Green (pics+word)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-vbdo.csv",  # Study Green (pics+word)          
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-pygj.csv",  # Study Teal (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-qza1.csv",  # Study Teal (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-eia6.csv",  # Study Teal (pics+word)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-7wwc.csv",  # Study Teal (pics+word)
          
        
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-j5hw.csv",  # Study Blue (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-g65w.csv",  # Study Blue (pics only) 
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-s7up.csv",  # Study Purple (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-qvph.csv",  # Study Purple (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-jsz4.csv",  # Study Pink (pics only)
          "./resources/experiment_6/experiment_6_data/data_exp_47727-v6_task-2j1b.csv")  # Study Pink (pics only)      

##  Create raw df from the above files, but only get the following columns:
    exp6__study_data <- map_dfr(exp6__study_files,~read_csv(.x, col_types = cols_only(
        "Participant Private ID" = 'c', "Participant Public ID"='c', "Screen Name" = 'c', "stim" = 'c',
        "correct_answer" = 'c', "Response" = 'c',"Reaction Time" = col_double()))) %>%
    ##  Rename some columns:
        rename(id = "Participant Private ID", prolific_id = "Participant Public ID", screen = "Screen Name",
               rt = "Reaction Time", response = "Response") %>%
    ##  Reorder columns:    
        select(id, prolific_id, screen, stim, correct_answer, response, rt) %>%
    ##  Set participant ID as the grouping variable, and arrange data by participant ID:
        group_by(id) %>%
        arrange(id) %>%         
    ##  Remove empty / unimportant rows:
        drop_na(screen) %>%
        filter(screen != "check") %>%
        filter(screen != "fixation") %>%
        filter(screen != "filler_start_fixation") %>%
        filter(screen != "filler_start_stim") %>%
        filter(screen != "filler_end_fixation") %>%
        filter(screen != "filler_end_stim") %>%
        add_count(screen, name = "total_resp")
    
    write.csv(exp6__study_data,'~/Desktop/exp6__study_data.csv', row.names = FALSE)

    
    
##  Calculate how many responses were correct for each stimuli format, then join these together:
    exp6__grey_word <- exp6__study_data %>%
        filter(str_detect(stim, "grey-word") & correct_answer == "word.png") %>%
        add_count(screen, name = "study_grey_word_resps") %>%
        filter(response == "word.png") %>%
        add_count(screen, name = "study_grey_word_correct") %>%
        distinct(id, .keep_all = TRUE) %>%
        select(id, study_grey_word_resps, study_grey_word_correct)
    exp6__distinctive_word <- exp6__study_data %>%
        filter(str_detect(stim, "distinctive-word") & correct_answer == "word.png") %>%
        add_count(screen, name = "study_distinctive_word_resps") %>%
        filter(response == "word.png") %>%
        add_count(screen, name = "study_distinctive_word_correct") %>%
        distinct(id, .keep_all = TRUE) %>%
        select(id, study_distinctive_word_resps, study_distinctive_word_correct)
    exp6__grey_drawing <- exp6__study_data %>%
        filter(str_detect(stim, "grey-drawing") & correct_answer == "drawing.png") %>%
        add_count(screen, name = "study_grey_drawing_resps") %>%
        filter(response == "drawing.png") %>%
        add_count(screen, name = "study_grey_drawing_correct") %>%
        distinct(id, .keep_all = TRUE) %>%
        select(id, study_grey_drawing_resps, study_grey_drawing_correct)
    exp6__col_drawing <- exp6__study_data %>%
        filter(str_detect(stim, "col-drawing") & correct_answer == "drawing.png") %>%
        add_count(screen, name = "study_col_drawing_resps") %>%
        filter(response == "drawing.png") %>%
        add_count(screen, name = "study_col_drawing_correct") %>%
        distinct(id, .keep_all = TRUE) %>%
        select(id, study_col_drawing_resps, study_col_drawing_correct)
    exp6__grey_photo <- exp6__study_data %>%
        filter(str_detect(stim, "grey-photo") & correct_answer == "photo.png") %>%
        add_count(screen, name = "study_grey_photo_resps") %>%
        filter(response == "photo.png") %>%
        add_count(screen, name = "study_grey_photo_correct") %>%
        distinct(id, .keep_all = TRUE) %>%
        select(id, study_grey_photo_resps, study_grey_photo_correct)
    exp6__col_photo <- exp6__study_data %>%
        filter(str_detect(stim, "col-photo") & correct_answer == "photo.png") %>%
        add_count(screen, name = "study_col_photo_resps") %>%
        filter(response == "photo.png") %>%
        add_count(screen, name = "study_col_photo_correct") %>%
        distinct(id, .keep_all = TRUE) %>%
        select(id, study_col_photo_resps, study_col_photo_correct)
    exp6__study_totals <- right_join(exp6__grey_word, exp6__distinctive_word, by = "id") %>%
        right_join(exp6__grey_drawing, by = "id") %>%
        right_join(exp6__col_drawing, by = "id") %>%
        right_join(exp6__grey_photo, by = "id") %>%
        right_join(exp6__col_photo, by = "id")
      
##  Add 'exp6__study_totals' to 'exp6__participant_info' df:
    exp6__participant_info <- exp6__participant_info %>%
        right_join(exp6__study_totals, by = "id") %>%
        mutate(study_responses_total = study_grey_word_resps + study_distinctive_word_resps +
                 study_grey_drawing_resps + study_col_drawing_resps +
                 study_grey_photo_resps + study_col_photo_resps) %>%
        mutate(study_correct = study_grey_word_correct + study_distinctive_word_correct +
                 study_grey_drawing_correct + study_col_drawing_correct +
                 study_grey_photo_correct + study_col_photo_correct) %>%
        mutate(study_correct_percent = study_correct*(100/study_responses_total)) %>%
        mutate(study_error = study_responses_total - study_correct) %>%
        mutate(study_error_percent = study_error*(100/study_responses_total)) %>%
        arrange(study_list, test_list) %>%
        select(id, prolific_id, everything())
```      